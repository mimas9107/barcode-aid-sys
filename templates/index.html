<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ¢ç¢¼æŸ¥è©¢ - MVP</title>

<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 14px; background:#f2f4f7; color:#222; }
  h2 { text-align:center; margin: 6px 0 14px 0; font-size:1.2rem; }
  .btn { width:100%; padding:12px; border-radius:8px; border:none; font-size:1rem; cursor:pointer; margin-bottom:10px; }
  .btn-primary { background:#2b7cff; color:#fff; }
  .btn-muted { background:#eee; color:#333; }
  #preview { width:100%; height:240px; background:#000; border-radius:8px; overflow:hidden; display:block; }
  .panel { background:#fff; padding:12px; border-radius:8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-top:12px;}
  .row { display:flex; margin-bottom:8px; }
  .label { width:32%; font-weight:700; color:#333; }
  .value { width:68%; word-break:break-all; }
  #history { margin-top:12px; }
  .hist-item { padding:10px; border-bottom:1px solid #efefef; display:block; }
  .hist-top { display:flex; justify-content:space-between; gap:8px; margin-bottom:6px; }
  .time { color:#888; font-size:0.85rem; }
  .barcode-text {font-family:monospace; color:#111;}
  .empty { color:#666; text-align:center; padding:12px; }
  .controls { display:flex; gap:8px; margin-top:8px; }
  .controls .btn { flex:1; padding:10px; }
  @media(min-width:600px){ #preview{height:320px} .btn{font-size:1.05rem} }
</style>

<!-- QuaggaJS -->
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
</head>
<body>

<h2>ğŸ“¦ æ¢ç¢¼æŸ¥è©¢ï¼ˆMVPï¼‰</h2>

<!-- å•Ÿå‹• / åœæ­¢æƒæ -->
<button id="btn-scan" class="btn btn-primary">å•Ÿå‹•ç›¸æ©Ÿæƒæ</button>
<div id="preview"></div>

<!-- ç›®å‰æ¢ç¢¼èˆ‡çµæœå¡ç‰‡ -->
<div class="panel" id="current-panel" style="display:none;">
  <div class="row"><div class="label">ç›®å‰æ¢ç¢¼</div><div class="value barcode-text" id="current-barcode"></div></div>
  <div class="row"><div class="label">å“å</div><div class="value" id="current-name"></div></div>
  <div class="row"><div class="label">åº«å­˜</div><div class="value" id="current-qty"></div></div>
  <div class="row"><div class="label">å€‰ä½</div><div class="value" id="current-loc"></div></div>
  <div class="row"><div class="label">ç”¨é€”</div><div class="value" id="current-usage"></div></div>

  <div class="controls">
    <button id="btn-rescan" class="btn btn-muted">é‡æ–°æƒæ</button>
    <button id="btn-clear" class="btn btn-muted">æ¸…é™¤æ­·å²</button>
  </div>
</div>

<!-- æ­·å²æ¸…å–® -->
<div class="panel" id="history-panel">
  <h3 style="margin:0 0 8px 0;">æƒææ­·å²ï¼ˆæœ€è¿‘ 10 ç­†ï¼‰</h3>
  <div id="history"></div>
</div>

<script>
/*
  åŠŸèƒ½èªªæ˜ï¼š
  - ä½¿ç”¨ Quagga å•Ÿå‹•æ‰‹æ©Ÿç›¸æ©Ÿæƒä¸€ç¶­ Code128ï¼ˆå¯æ“´å……æ”¯æ´å…¶ä»– readerï¼‰
  - æƒåˆ° barcode å¾Œå‘¼å« /api/query?code=... å–å¾—è³‡æ–™
  - é¡¯ç¤ºåœ¨ä¸Šæ–¹ã€Œç›®å‰æ¢ç¢¼ã€å€å¡Šï¼Œä¸¦æŠŠè©²ç­† push åˆ°æ­·å² (æœ€å¤šä¿ç•™ MAX_HISTORY)
  - ä½¿ç”¨ localStorage ä¿ç•™æ­·å²ï¼Œé é¢é‡æ–°æ•´ç†ä»ä¿ç•™
  - é˜²æŠ–ï¼šçŸ­æ™‚é–“å…§é‡è¤‡åµæ¸¬åŒä¸€ barcode å‰‡å¿½ç•¥ï¼ˆDEBOUNCE_MSï¼‰
*/

const MAX_HISTORY = 10;        // ä¿ç•™æ­·å²ç­†æ•¸
const DEBOUNCE_MS = 1500;     // åŒä¸€æ¢ç¢¼åœ¨æ­¤æ™‚é–“å…§é‡è¤‡åµæ¸¬æœƒè¢«å¿½ç•¥
let lastDetected = { code: null, time: 0 };
let scanning = false;
let historyList = []; // {ts, barcode, status, product_name, qty, location, usage}

// å…ƒç´ 
const btnScan = document.getElementById('btn-scan');
const preview = document.getElementById('preview');
const currentPanel = document.getElementById('current-panel');
const currentBarcode = document.getElementById('current-barcode');
const currentName = document.getElementById('current-name');
const currentQty = document.getElementById('current-qty');
const currentLoc = document.getElementById('current-loc');
const currentUsage = document.getElementById('current-usage');
const historyDiv = document.getElementById('history');
const btnRescan = document.getElementById('btn-rescan');
const btnClear = document.getElementById('btn-clear');

// è®€å– localStorage åˆå§‹æ­·å²
function loadHistoryFromStorage() {
  try {
    const raw = localStorage.getItem('scan_history_v1');
    if (raw) historyList = JSON.parse(raw) || [];
  } catch(e) { historyList = []; }
}
function saveHistoryToStorage() {
  try { localStorage.setItem('scan_history_v1', JSON.stringify(historyList)); } catch(e){/* ignore */ }
}

// å°‡ä¸€ç­†çµæœ push åˆ° historyï¼Œä¸¦æ¸²æŸ“
function pushHistory(item) {
  historyList.unshift(item); // newest at top
  if (historyList.length > MAX_HISTORY) historyList = historyList.slice(0, MAX_HISTORY);
  saveHistoryToStorage();
  renderHistory();
}

// æ¸²æŸ“æ­·å²
function renderHistory() {
  if (!historyList.length) {
    historyDiv.innerHTML = '<div class="empty">å°šç„¡æƒæç´€éŒ„</div>';
    return;
  }
  historyDiv.innerHTML = '';
  historyList.forEach(h => {
    const el = document.createElement('div');
    el.className = 'hist-item';
    const top = document.createElement('div');
    top.className = 'hist-top';
    top.innerHTML = `<div class="time">${new Date(h.ts).toLocaleString()}</div><div class="barcode-text">${h.barcode}</div>`;
    const detail = document.createElement('div');
    if (h.status === 'ok') {
      detail.innerHTML = `<div style="font-weight:600">${escapeHtml(h.product_name)}</div>
                          <div style="color:#444">åº«å­˜ï¼š${escapeHtml(String(h.qty))} &nbsp;ï½œ&nbsp; å€‰ä½ï¼š${escapeHtml(h.location)}</div>
                          <div style="color:#666; margin-top:6px;">ç”¨é€”ï¼š${escapeHtml(h.usage)}</div>`;
    } else {
      detail.innerHTML = `<div style="color:#b00; font-weight:600;">${escapeHtml(h.msg || 'æŸ¥è©¢éŒ¯èª¤')}</div>`;
    }
    el.appendChild(top);
    el.appendChild(detail);
    historyDiv.appendChild(el);
  });
}

// æ›´æ–°ä¸Šæ–¹ç›®å‰é¡¯ç¤ºå¡
function updateCurrent(resultObj) {
  currentPanel.style.display = 'block';
  currentBarcode.textContent = resultObj.barcode || '';
  currentName.textContent = resultObj.product_name || (resultObj.status === 'not_found' ? 'æŸ¥ç„¡è³‡æ–™' : '');
  currentQty.textContent = (resultObj.status === 'ok') ? String(resultObj.qty) : '-';
  currentLoc.textContent = resultObj.location || '-';
  currentUsage.textContent = resultObj.usage || '-';
}

// å‘¼å«å¾Œç«¯ API æŸ¥æ¢ç¢¼
async function fetchItem(barcode) {
  const api = `/api/query?code=${encodeURIComponent(barcode)}`;
  const ts = Date.now();
  // å…ˆæŠŠç›®å‰æ¢ç¢¼é¡¯ç¤ºï¼ˆé¿å…ç­‰å¾…å¤ªä¹…ï¼‰
  updateCurrent({ barcode, status: 'pending' });

  try {
    const r = await fetch(api);
    const json = await r.json();

    if (json.status === 'ok') {
      const item = {
        ts, barcode,
        status: 'ok',
        product_name: json.product_name || '',
        qty: json.qty || '',
        location: json.location || '',
        usage: json.usage || ''
      };
      updateCurrent(item);
      pushHistory(item);
    } else if (json.status === 'not_found') {
      const item = { ts, barcode, status: 'not_found', msg: 'æŸ¥ç„¡æ­¤æ¢ç¢¼' };
      updateCurrent(item);
      pushHistory(item);
    } else {
      const item = { ts, barcode, status: 'error', msg: json.msg || 'æœªçŸ¥éŒ¯èª¤' };
      updateCurrent(item);
      pushHistory(item);
    }
  } catch (e) {
    const item = { ts, barcode, status: 'error', msg: String(e) };
    updateCurrent(item);
    pushHistory(item);
  }
}

// å•Ÿå‹• Quagga æƒæï¼ˆCode128ï¼‰
function startQuagga() {
  if (scanning) return;
  scanning = true;
  btnScan.textContent = 'åœæ­¢æƒæ';
  btnScan.classList.remove('btn-primary');
  btnScan.classList.add('btn-muted');

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: preview,
      constraints: { facingMode: "environment" } // å¾Œé¡é ­
    },
    decoder: {
      readers: ["code_128_reader"] // åªè®€ä¸€ç¶­ Code128; å¦‚éœ€åŠ  QR å¯æ“´å……
    },
    locate: true
  }, function(err) {
    if (err) {
      console.error('Quagga init error', err);
      alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š' + err);
      scanning = false;
      btnScan.textContent = 'å•Ÿå‹•ç›¸æ©Ÿæƒæ';
      btnScan.classList.remove('btn-muted');
      btnScan.classList.add('btn-primary');
      return;
    }
    Quagga.start();
  });

  Quagga.onDetected(onDetectedHandler);
}

// åœæ­¢ Quagga
function stopQuagga() {
  if (!scanning) return;
  scanning = false;
  Quagga.offDetected(onDetectedHandler);
  try { Quagga.stop(); } catch(e){/* ignore */ }
  btnScan.textContent = 'å•Ÿå‹•ç›¸æ©Ÿæƒæ';
  btnScan.classList.remove('btn-muted');
  btnScan.classList.add('btn-primary');
}

// åµæ¸¬äº‹ä»¶è™•ç†ï¼ˆåŒ…å«å»é‡ï¼‰
function onDetectedHandler(data) {
  const code = data && data.codeResult && data.codeResult.code;
  if (!code) return;
  const now = Date.now();

  // é˜²æŠ–ï¼šåŒä¸€ barcode åœ¨çŸ­æ™‚é–“å…§å¿½ç•¥é‡è¤‡
  if (lastDetected.code === code && (now - lastDetected.time) < DEBOUNCE_MS) {
    return;
  }
  lastDetected = { code, time: now };

  // åœ scannerï¼ˆå¦‚éœ€é€£çºŒæƒå¯ä»¥æ”¹ç‚ºä¸ stopï¼‰
  try { Quagga.stop(); } catch(e){}
  scanning = false;
  btnScan.textContent = 'å•Ÿå‹•ç›¸æ©Ÿæƒæ';
  btnScan.classList.remove('btn-muted');
  btnScan.classList.add('btn-primary');

  // å‘¼å« API ä¸¦é¡¯ç¤º
  fetchItem(code);
}

// small helper for escaping HTML
function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// UI æŒ‰éˆ•ç¶å®š
btnScan.addEventListener('click', () => {
  if (!scanning) startQuagga();
  else stopQuagga();
});
btnRescan.addEventListener('click', () => { // é‡æ–°æƒæï¼šæ¸…æ‰ç›®å‰é¡¯ç¤ºä½†ä¿ç•™æ­·å²
  currentBarcode.textContent = '';
  currentName.textContent = '';
  currentQty.textContent = '';
  currentLoc.textContent = '';
  currentUsage.textContent = '';
  if (!scanning) startQuagga();
});
btnClear.addEventListener('click', () => {
  if (!confirm('ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿæ­·å²ç´€éŒ„å—ï¼Ÿ')) return;
  historyList = [];
  saveHistoryToStorage();
  renderHistory();
  // åŒæ™‚æ¸…é™¤ç›®å‰é¡¯ç¤º
  currentPanel.style.display = 'none';
});

// Initialize from storage & render
loadHistoryFromStorage();
renderHistory();
</script>
</body>
</html>
