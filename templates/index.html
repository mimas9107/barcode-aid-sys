<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¢ç¢¼æŸ¥è©¢ç³»çµ±</title>
<style>
body { font-family: Arial; padding: 20px; background:#f5f5f5; }
h2 { text-align: center; margin-top:0; font-size:1.4rem; }
#qr-reader { width: 100%; max-width: 400px; margin: auto; }
button { width: 100%; padding:14px; font-size:1.1rem; border:none; border-radius:6px; background:#2b7cff; color:white; cursor:pointer; margin-bottom:15px; }
button:active { opacity:0.8; }
.result-box { margin-top:18px; padding:15px; border-radius:6px; background:white; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
.result-item { margin-bottom:10px; padding:8px; border-bottom:1px solid #ccc; word-break:break-all; }
.result-item b { display:inline-block; width:60px; }
</style>

<!-- ä½¿ç”¨æœ€æ–° html5-qrcode CDN -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<h2>ğŸ“¦ æ¢ç¢¼æŸ¥è©¢ç³»çµ±</h2>
<p>é»æŒ‰ä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•ç›¸æ©Ÿæƒææ¢ç¢¼ (Code128 / Code39 / QRcode)</p>

<button id="start-scan">å•Ÿå‹•æƒæ</button>
<div id="qr-reader" style="display:none;"></div>

<div class="result-box" id="result-box" style="display:none;">
    <h3>æœ€è¿‘æƒæçµæœï¼ˆæœ€å¤š 10 ç­†ï¼‰</h3>
    <div id="result-list"></div>
</div>

<script>
let scanHistory = [];
let html5QrcodeScanner;

document.getElementById("start-scan").addEventListener("click", function() {
    document.getElementById("qr-reader").style.display = "block";
    
    if(!html5QrcodeScanner) {
        html5QrcodeScanner = new Html5Qrcode("qr-reader");
    }

    html5QrcodeScanner.start(
        { facingMode: "environment" },
        {
            fps: 10,
            qrbox: 250,
            formatsToSupport: [
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.QR_CODE
            ]
        },
        qrCodeMessage => {
            html5QrcodeScanner.pause(); // æš«åœæƒæï¼Œé¿å…é€£çºŒè§¸ç™¼
            queryAPI(qrCodeMessage);
        },
        errorMessage => {
            // æƒæä¸­éŒ¯èª¤å¯å¿½ç•¥
        }
    ).catch(err => {
        alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š" + err);
    });
});

function queryAPI(code) {
    fetch(`/api/query?code=${encodeURIComponent(code)}`)
        .then(r => r.json())
        .then(res => {
            const item = {
                barcode: code,
                status: res.status,
                product_name: res.product_name || "",
                qty: res.qty || "",
                location: res.location || "",
                usage: res.usage || "",
                msg: res.msg || ""
            };

            scanHistory.unshift(item);
            if(scanHistory.length > 10) scanHistory.pop();

            updateResultList();
            html5QrcodeScanner.resume(); // æƒæå®Œæˆå¾Œç¹¼çºŒæƒä¸‹ä¸€æ”¯
        })
        .catch(err => {
            alert("æŸ¥è©¢å¤±æ•—ï¼š" + err);
            html5QrcodeScanner.resume();
        });
}

function updateResultList() {
    const container = document.getElementById("result-list");
    container.innerHTML = "";
    document.getElementById("result-box").style.display = scanHistory.length ? "block" : "none";

    scanHistory.forEach(item => {
        let html = '';
        if(item.status === "ok") {
            html += `<div class="result-item"><b>æ¢ç¢¼:</b>${item.barcode}<br>`;
            html += `<b>å“å:</b>${item.product_name}<br>`;
            html += `<b>åº«å­˜:</b>${item.qty}<br>`;
            html += `<b>å€‰ä½:</b>${item.location}<br>`;
            html += `<b>ç”¨é€”:</b>${item.usage}</div>`;
        } else {
            html += `<div class="result-item" style="color:red;"><b>${item.barcode}</b>: ${item.msg}</div>`;
        }
        container.innerHTML += html;
    });
}
</script>

</body>
</html>
